---
import "../styles/global.css";
import Layout from "../layouts/Layout.astro";
// In dev mode, don't use base URL; in production, use it
const baseUrl = import.meta.env.DEV ? "" : import.meta.env.BASE_URL;

const data = [
  {
    imageLink: `${baseUrl}/wilfred-hero.webp`,
    imageAlt: "Wilfred Hero",
  },
  {
    imageLink: `${baseUrl}/wilfred-hero2.webp`,
    imageAlt: "Wilfred Hero 2",
  },
  {
    imageLink: `${baseUrl}/wilfred-hero3.webp`,
    imageAlt: "Wilfred Hero 3",
  },
  {
    imageLink: `${baseUrl}/wilfred-hero.webp`,
    imageAlt: "Wilfred Hero",
  },
  {
    imageLink: `${baseUrl}/wilfred-hero2.webp`,
    imageAlt: "Wilfred Hero 2",
  },
];

const ratingScale = [1, 2, 3, 4, 5];
---

<Layout>
  <section
    id="gallery"
    class="min-h-100 flex items-center justify-center py-12 md:py-20 transition-colors duration-300"
  >
    <div class="w-full max-w-7xl px-4 sm:px-6">
      <div
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-6"
      >
        {
          data.map((item, index) => (
            <div class="gallery-item-wrapper">
              <img
                class="gallery-image w-full h-64 md:h-80 object-cover rounded-lg shadow-md cursor-pointer transition-opacity"
                src={item.imageLink}
                alt={item.imageAlt}
                data-index={index}
              />
              <div class="rating-wrapper" data-image-id={index}>
                <div class="rating-hearts">
                  {ratingScale.map((value) => (
                    <button
                      type="button"
                      class="heart"
                      data-value={value}
                    >
                      â™¥
                    </button>
                  ))}
                </div>
                <span class="rating-average">0.0 (0)</span>
              </div>
            </div>
          ))
        }
      </div>
    </div>
  </section>
</Layout>

<script>
  import { gsap } from "gsap";

  const RATING_API_URL = "/api/ratings.json";

  type RatingSummary = {
    [imageId: string]: {
      average: number;
      count: number;
    };
  };

  function updateHeartVisual(
    hearts: NodeListOf<HTMLButtonElement>,
    value: number,
  ) {
    hearts.forEach((heart) => {
      const heartValue = Number(heart.dataset.value);
      if (heartValue <= value) {
        heart.classList.add("filled");
      } else {
        heart.classList.remove("filled");
      }
    });
  }

  async function setupRatings() {
    const wrappers = Array.from(
      document.querySelectorAll<HTMLElement>(".rating-wrapper"),
    );

    // Load existing averages
    try {
      const res = await fetch(RATING_API_URL);
      if (res.ok) {
        const data = (await res.json()) as RatingSummary;

        wrappers.forEach((wrapper) => {
          const imageId = wrapper.dataset.imageId;
          if (!imageId) return;

          const avgSpan =
            wrapper.querySelector<HTMLElement>(".rating-average");
          const hearts =
            wrapper.querySelectorAll<HTMLButtonElement>(".heart");

          const info = data[imageId];
          if (info && avgSpan) {
            const avgRounded = info.average.toFixed(1);
            avgSpan.textContent = `${avgRounded} (${info.count})`;
            updateHeartVisual(hearts, Math.round(info.average));
          } else if (avgSpan) {
            avgSpan.textContent = "0.0 (0)";
          }
        });
      }
    } catch (error) {
      console.error("Failed to load ratings", error);
    }

    // Set up click handlers
    wrappers.forEach((wrapper) => {
      const imageId = wrapper.dataset.imageId;
      if (!imageId) return;

      const avgSpan =
        wrapper.querySelector<HTMLElement>(".rating-average");
      const hearts =
        wrapper.querySelectorAll<HTMLButtonElement>(".heart");

      hearts.forEach((heart) => {
        heart.addEventListener("click", async (event) => {
          event.preventDefault();
          const ratingValue = Number(heart.dataset.value);
          if (!ratingValue) return;

          try {
            const res = await fetch(RATING_API_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ imageId, rating: ratingValue }),
            });

            if (!res.ok) return;

            const result = (await res.json()) as {
              average: number;
              count: number;
            };

            if (avgSpan) {
              const avgRounded = result.average.toFixed(1);
              avgSpan.textContent = `${avgRounded} (${result.count})`;
            }

            updateHeartVisual(hearts, Math.round(result.average));
          } catch (error) {
            console.error("Failed to submit rating", error);
          }
        });
      });
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Set initial states for gallery images
    gsap.set(".gallery-image", { opacity: 0, y: 50, scale: 0.8 });

    // Create entrance animation with stagger
    gsap.to(".gallery-image", {
      opacity: 1,
      y: 0,
      scale: 1,
      duration: 0.8,
      stagger: 0.15,
      ease: "power3.out",
      delay: 0.3,
    });

    // Get all gallery images
    const galleryImages = Array.from(
      document.querySelectorAll<HTMLImageElement>(".gallery-image"),
    );

    // Add continuous floating animations with different timings
    galleryImages.forEach((img, index: number) => {
      gsap.to(img, {
        y: -10 - (index % 3) * 3,
        rotation: index % 2 === 0 ? 2 : -2,
        duration: 2.5 + (index % 3) * 0.5,
        ease: "sine.inOut",
        repeat: -1,
        yoyo: true,
        delay: 0.8 + (index % 3) * 0.3,
      });

      // Add hover effects
      img.addEventListener("mouseenter", () => {
        gsap.to(img, {
          scale: 1.05,
          rotation: 0,
          duration: 0.3,
          ease: "power2.out",
        });
      });

      img.addEventListener("mouseleave", () => {
        gsap.to(img, {
          scale: 1,
          rotation: index % 2 === 0 ? 2 : -2,
          duration: 0.3,
          ease: "power2.out",
        });
      });
    });

    void setupRatings();
  });
</script>
